{% liquid
  assign desktop_image = section.settings.image
  assign mobile_image = section.settings.mobile_image


  assign overlay_opacity = section.settings.overlay_opacity | default: 80 | divided_by: 100.0

  assign max_date_string = section.settings.expiration_date | date: "%s" | plus: 8553600 | date: "%Y-%m-%d %H:%M"
  assign expiration_date_iso = section.settings.expiration_date | default: max_date_string
%}

{% capture styles %}
  :root {
    /* Hardcoded dark theme colors for robustness and to match the image */
    --overlay-color: {{ section.settings.overlay | default: '#1C1C1C' }};
    --overlay-opacity: {{ overlay_opacity }};
    --text-color: {{ section.settings.text_color | default: '#ffffff' }};
    --flip-bg-color: {{ section.settings.flip_bg_color | default: '#ffffff' }};
    --flip-text-color: {{ section.settings.flip_text_color | default: '#1c1c1c' }};
    --countdown-max-width: 500px;
  }

  .sale-banner-section {
    position: relative;
    overflow: hidden;
    color: var(--text-color);
  }

  /* Image and Overlay setup */
  .sale-banner-image-wrapper {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
  }
  .sale-banner-image-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .sale-banner-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--overlay-color);
    opacity: var(--overlay-opacity);
    z-index: 2;
  }

  /* Main Content Container */
  .sale-banner-content {
    position: relative;
    z-index: 3;
    padding: 60px 20px;
    display: flex;
    align-items: center;
    min-height: 400px;
    max-width: 1280px;
    margin: 0 auto;
  }
  @media (min-width: 1024px) {
    .sale-banner-content {
      padding: 80px 40px;
      min-height: 450px; 
    }
  }

  /* Inner Flex for Desktop Layout (Text Left, Timer Right) */
  .sale-banner-content-inner {
    display: flex;
    flex-direction: column;
    width: 100%;
    gap: 40px; /* Space between content blocks on mobile/small screens */
    align-items: center;
    justify-content: center;
  }
  @media (min-width: 1024px) {
    .sale-banner-content-inner {
      flex-direction: row;
      justify-content: space-between;
      align-items: center; /* Vertical alignment */
    }
  }

  /* Text Block Styling (Left aligned on desktop) */
  .sale-banner-text-block {
    max-width: 550px;
    width: 100%;
    text-align: center; /* Center on mobile */
  }
  @media (min-width: 1024px) {
    .sale-banner-text-block {
      max-width: 60%;
      text-align: left;
    }
  }

  /* Text Styles */
  .sale-banner-tag {
    font-size: 14px;
    letter-spacing: 2px;
    margin-bottom: 10px;
    text-transform: uppercase;
    font-weight: 500;
  }
  .sale-banner-title {
    font-size: 40px;
    font-weight: 800;
    line-height: 1.1;
    margin-bottom: 20px;
  }
  .sale-banner-description {
    font-size: 16px;
    margin-bottom: 30px;
    line-height: 1.5;
    opacity: 0.8;
  }

  /* Countdown Timer Styling (Right aligned on desktop) */
  .countdown-timer {
    display: flex;
    gap: 20px;
    margin: 0;
    width: 100%;
    max-width: var(--countdown-max-width);
    justify-content: center; /* Center on mobile */
    align-items: flex-end;
  }
  @media (min-width: 1024px) {
    .countdown-timer {
      max-width: 40%;
      justify-content: flex-end; /* Push to the right */
    }
  }

  .countdown-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    line-height: 1;
  }

  /* Flip Card Styling (Removed background/border to match image) */
  .countdown-value-container {
    display: flex;
    justify-content: center;
    align-items: center;
    color: var(--text-color); /* Use main text color for digits */
    padding: 0; /* No padding needed for simple numbers */
    min-width: 45px;
    height: 60px;
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 5px;
    position: relative;
    overflow: hidden;
  }
  @media (min-width: 1024px) {
    .countdown-value-container {
      min-width: 60px;
      height: 75px;
      font-size: 20px;
    }
  }

  .countdown-value {
    width: 100%;
    text-align: center;
    position: absolute;
  }

  .countdown-label {
    font-size: 10px;
    text-transform: uppercase;
    font-weight: 500;
    letter-spacing: 1px;
    color: var(--text-color);
    opacity: 0.8;
  }

  /* Button Styling */
  .shop-now-button {
    display: inline-block;
    padding: 14px 35px;
    background-color: #fff;
    color: #1c1c1c;
    text-transform: uppercase;
    font-weight: 600;
    font-size: 14px;
    letter-spacing: 1px;
    border-radius: 0; /* Square button to match image */
    text-decoration: none;
    transition: background-color 0.3s, opacity 0.3s;
  }
  @media (max-width: 1023px) {
    .shop-now-button {
      /* Center button on mobile */
      margin: 0 auto;
      display: table;
    }
  }
  .shop-now-button:hover {
    opacity: 0.9;
  }

  /* Separator colon style */
  .countdown-colon {
    font-size: 40px;
    font-weight: 300;
    color: var(--text-color);
    opacity: 0.6;
    margin-bottom: 10px;
    padding-bottom: 0.25rem; /* Align colon baseline better with numbers */
  }
  @media (min-width: 1024px) {
    .countdown-colon {
      font-size: 50px;
    }
  }

{% endcapture %}
<style>
  {{ styles }}
</style>

<div
  class="sale-banner-section {% if section.settings.separate_section_with_border %}border-t border-gray-700{% endif %}"
  data-section-id="{{ section.id }}"
  data-expires-action="{{ section.settings.expires_action }}"
  data-expiration-date="{{ expiration_date_iso }}">

  {% comment %} Background Image (Desktop) {% endcomment %}
  <div class="sale-banner-image-wrapper hidden lg:block">
    {% if desktop_image != blank %}
      {{ desktop_image | image_url: width: 3000 | image_tag: loading: 'lazy', widths: '500, 1000, 2000, 3000', sizes: '100vw', alt: desktop_image.alt
      }}
    {% else %}
      <div class="w-full h-full bg-gray-900"></div>
    {% endif %}
  </div>

  {% comment %} Background Image (Mobile) {% endcomment %}
  <div class="sale-banner-image-wrapper block lg:hidden">
    {% if mobile_image != blank %}
      {{ mobile_image | image_url: width: 1200 | image_tag: loading: 'lazy', widths: '500, 800, 1200', sizes: '100vw', alt: mobile_image.alt
      }}
    {% elsif desktop_image != blank %}
      {% comment %} Fallback to desktop image if mobile is not set {% endcomment %}
      {{ desktop_image | image_url: width: 1200 | image_tag: loading: 'lazy', widths: '500, 800, 1200', sizes: '100vw', alt: desktop_image.alt
      }}
    {% else %}
      <div class="w-full h-full bg-gray-900"></div>
    {% endif %}
  </div>

  {% comment %} Dark Overlay {% endcomment %}
  <div class="sale-banner-overlay"></div>

  <div class="sale-banner-content">
    <div class="sale-banner-content-inner">

      {% comment %} Text Block (On the Left for desktop) {% endcomment %}
      <div class="sale-banner-text-block">
        {% if section.settings.subheading != blank %}
          <p class="sale-banner-tag">{{ section.settings.subheading | escape }}</p>
        {% endif %}

        {% if section.settings.heading != blank %}
          <h2 class="sale-banner-title">{{ section.settings.heading | escape }}</h2>
        {% endif %}

        {% if section.settings.content != blank %}
          <p class="sale-banner-description">{{ section.settings.content | escape }}</p>
        {% endif %}

        {% if section.settings.button_text != blank %}
          <a href="{{ section.settings.button_link | default: '#' }}" class="shop-now-button">
            {{ section.settings.button_text | escape }}
          </a>
        {% endif %}
      </div>

      {% comment %} Countdown Timer Display (On the Right for desktop) {% endcomment %}
      <div
        class="countdown-timer"
        data-expires-action="{{ section.settings.expires_action }}"
        id="sale-countdown-{{ section.id }}">

        {% assign countdown_items = 'day,hours,min,sec' | split: ',' %}

        {% for item in countdown_items %}
          <div class="countdown-item">
            <div class="countdown-value-container">
              <span class="countdown-value" data-unit="{{ item | escape }}">00</span>
            </div>
            <span class="countdown-label">{{ item | upcase }}</span>
          </div>

          {% unless forloop.last %}
            <span class="countdown-colon">:</span>
          {% endunless %}
        {% endfor %}

      </div>

    </div>
  </div>
</div>

{% comment %} Add the necessary JavaScript to initialize the countdown {% endcomment %}
<script>
  if (typeof window.initSaleCountdown === 'undefined') {
    window.initSaleCountdown = (elementId, expirationDate, expiresAction) => {
      const countdownElement = document.getElementById(elementId);
      if (!countdownElement) return;

      const endDate = new Date(expirationDate).getTime();

      const updateCountdown = () => {
        const now = new Date().getTime();
        const distance = endDate - now;
        const parentSection = countdownElement.closest('.sale-banner-section');

        if (distance < 0) {
          clearInterval(countdownInterval);
          if (expiresAction === 'hide') {
            parentSection.style.display = 'none';
          } else {
            // Leave timer at zero
            countdownElement.querySelectorAll('.countdown-value').forEach(el => el.textContent = '00');
          }
          return;
        }

        // Time calculations
        const oneSecond = 1000;
        const oneMinute = oneSecond * 60;
        const oneHour = oneMinute * 60;
        const oneDay = oneHour * 24;

        const days = Math.floor(distance / oneDay);
        const hours = Math.floor((distance % oneDay) / oneHour);
        const minutes = Math.floor((distance % oneHour) / oneMinute);
        const seconds = Math.floor((distance % oneMinute) / oneSecond);

        // Update the elements (padStart ensures two digits, e.g., 05)
        const updateUnit = (unit, value) => {
          const element = countdownElement.querySelector(`[data-unit="${unit}"]`);
          if (element) {
            element.textContent = String(value).padStart(2, '0');
          }
        };

        updateUnit('day', days);
        updateUnit('hours', hours);
        updateUnit('min', minutes);
        updateUnit('sec', seconds);
      };

      // Update the countdown every 1 second
      const countdownInterval = setInterval(updateCountdown, 1000);
      updateCountdown(); // Initial call to display immediately
    };
  }

  // Find the section element and initialize the countdown
  const sectionElement = document.querySelector('[data-section-id="{{ section.id }}"]');
  if (sectionElement) {
    const sectionId = sectionElement.dataset.sectionId;
    const expirationDate = sectionElement.dataset.expirationDate;
    const expiresAction = sectionElement.dataset.expiresAction;

    // Use a small delay to ensure the DOM is fully ready for the querySelector
    setTimeout(() => {
        window.initSaleCountdown(`sale-countdown-${sectionId}`, expirationDate, expiresAction);
    }, 100);
  }
</script>

{% schema %}
  {
    "name": "Countdown Banner",
    "class": "section-countdown-banner",
    "settings": [
      {
        "type": "header",
        "content": "Content"
      },
      {
        "type": "text",
        "id": "subheading",
        "label": "Subheading",
        "default": "LIMITED TIME ONLY"
      },
      {
        "type": "text",
        "id": "heading",
        "label": "Heading",
        "default": "SUPER SALE UP TO 40% OFF"
      },
      {
        "type": "textarea",
        "id": "content",
        "label": "Content",
        "default": "Shop our selection of exclusive handbags and backpacks at reduced price during the Super Sale. Hurry up!"
      }, {
        "type": "text",
        "id": "button_text",
        "label": "Button text",
        "default": "SHOP NOW"
      }, {
        "type": "url",
        "id": "button_link",
        "label": "Button link"
      }, {
        "type": "header",
        "content": "Image & Layout"
      }, {
        "type": "image_picker",
        "id": "image",
        "label": "Desktop image (3000 x 800px recommended)"
      }, {
        "type": "image_picker",
        "id": "mobile_image",
        "label": "Mobile image (1200 x 1600px recommended)"
      }, {
        "type": "header",
        "content": "Timer Settings"
      }, {
        "type": "text",
        "id": "expiration_date",
        "label": "Expiration date",
        "info": "Use the format YYYY-MM-DD HH:MM. (e.g., 2035-04-25 10:00)",
        "default": "2035-04-25 10:00"
      }, {
        "type": "select",
        "id": "expires_action",
        "label": "When timer expires...",
        "default": "zero",
        "options": [
          {
            "value": "hide",
            "label": "Hide section"
          }, {
            "value": "zero",
            "label": "Leave timer at zero"
          }
        ]
      }, {
        "type": "checkbox",
        "id": "separate_section_with_border",
        "default": false,
        "label": "Separate section with border"
      }, {
        "type": "header",
        "content": "Colors"
      }, {
        "type": "color",
        "id": "text_color",
        "label": "Text color",
        "default": "#ffffff"
      }, {
        "type": "color",
        "id": "overlay",
        "label": "Overlay color",
        "default": "#1C1C1C"
      }, {
        "type": "range",
        "id": "overlay_opacity",
        "min": 0,
        "max": 100,
        "step": 1,
        "unit": "%",
        "label": "Overlay opacity",
        "default": 80
      }, {
        "type": "color",
        "id": "flip_bg_color",
        "label": "Flip background (Not used, set to transparent)",
        "default": "#1C1C1C"
      }, {
        "type": "color",
        "id": "flip_text_color",
        "label": "Flip text color (Not used, uses Text Color)",
        "default": "#ffffff"
      }
    ],
    "presets": [
      {
        "name": "Sale Countdown Banner (Left Content)",
        "settings": {
          "overlay_opacity": 80
        }
      }
    ]
  }
{% endschema %}