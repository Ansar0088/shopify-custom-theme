{% assign current_scheme = section.settings.color_scheme %}
{% assign blocks_count = section.blocks.size %}

{% assign has_blocks = false %}
{% if blocks_count > 0 %}
  {% assign has_blocks = true %}
{% endif %}

<style>
  /* --- General Section Styles --- */
  .section-{{ section.id }} {
    background-color: var(--color-background);
    color: var(--color-primary-text);
    padding: 50px 10px;
    text-align: center;
    overflow: hidden;
    position: relative;

    {% if section.settings.separator %}
      border-top: 1px solid var(--color-border);
    {% endif %}
  }

  /* --- Content/Slider Container --- */
  .testimonial-slider-container {
    max-width: 1000px;
    margin: 0 auto;
    position: relative;
    transition: height 0.5s ease-in-out;
  }

  .testimonial-slide {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    /* Default hidden state */
    opacity: 0;
    visibility: hidden;
    /* Smooth transition for fade effect */
    transition: opacity 0.5s ease-in-out
    , visibility 0.5s ease-in-out;
    pointer-events: none;
    z-index: 1;
  }

  /* Active slide state */
  .testimonial-slide.active {
    opacity: 1;
    visibility: visible;
    position: relative;
    pointer-events: auto;
    z-index: 2;
    /* Ensure the active slide is on top */
  }

  /* --- Content Text Styles --- */
  .testimonial-subheading {
    font-family: {{ settings.font_heading.family }}, 
    {{ settings.font_heading.fallback_families }};
    font-size: {{ settings.font_size_base | times: 0.8 | round }}px;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 8px;
    color: var(--color-secondary-text);
    font-weight: {{ settings.font_heading.weight }};
  }

  .testimonial-heading {
    font-family: {{ settings.font_heading.family }}, 
    {{ settings.font_heading.fallback_families }};
    font-size: {{ settings.font_size_heading_large }}px;
    font-weight: {{ settings.font_weight_bold }};
    text-transform: uppercase;
    margin-bottom: 40px;
    color: var(--color-header-text);
  }

  .testimonial-content {
    font-family: {{ settings.font_body.family }}, 
    {{ settings.font_body.fallback_families }};
    font-size: {{ settings.font_size_base | times: 1.15 | round }}px;
    line-height: 1.6;
    max-width: 700px;
    margin: 0 auto 40px;
    font-weight: {{ settings.font_weight_normal }};
    color: var(--color-primary-text);
  }

  .testimonial-content p {
    margin: 0;
    padding: 0;
  }

  /* --- Dot Navigation --- */
  .slider-dots {
    margin-top: 30px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
  }

  .dot {
    width: 8px;
    height: 8px;
    background-color: var(--color-border);
    border-radius: 50%;
    cursor: pointer;
    transition: background-color 0.3s
    , transform 0.3s;
  }

  .dot.active {
    background-color: var(--color-primary-text);
    transform: scale(1.1);
  }

  .dot:hover {
    background-color: var(--color-link);
  }

  /* --- Responsive Adjustments --- */
  @media (max-width: 768px) {
    .section-{{ section.id }} {
      padding: 60px 20px;
    }

    .testimonial-heading {
      font-size: {{ settings.font_size_heading_medium }}px;
      margin-bottom: 25px;
    }

    .testimonial-content {
      font-size: {{ settings.font_size_base }}px;
      margin-bottom: 30px;
    }

    .testimonial-subheading {
      font-size: {{ settings.font_size_base | times: 0.75 | round }}px;
    }
  }

  @media (max-width: 480px) {
    .testimonial-heading {
      font-size: {{ settings.font_size_heading_medium | times: 0.9 | round }}px;
    }
  }
</style>

<section
  id="testimonial-slider-{{ section.id }}"
  class="section-{{ section.id }} color-{{ current_scheme }}"
  data-auto-rotate="{{ section.settings.auto_rotate }}">

  <div class="testimonial-slider-container" id="testimonial-slider-container-{{ section.id }}">
    {% for block in section.blocks %}
      {% assign is_first = forloop.first %}
      <div
        class="testimonial-slide {% if is_first %}active{% endif %}"
        data-index="{{ forloop.index0 }}"
        data-active="{{ is_first }}">

        {% if block.settings.subheading != blank %}
          <p class="testimonial-subheading">{{ block.settings.subheading | escape }}</p>
        {% endif %}

        <h2 class="testimonial-heading">
          {{ block.settings.heading | escape }}
        </h2>

        <div class="testimonial-content">
          {% if block.settings.content != blank %}
            {{ block.settings.content }}
          {% else %}
            <p>SLIDE {{ forloop.index }}: Please add content to this testimonial block in the Theme Editor.</p>
          {% endif %}
        </div>
      </div>
    {% else %}
      {% comment %} Default Content/Empty State Fallback - Shows the general placeholder {% endcomment %}
      <div
        class="testimonial-slide active"
        data-index="0"
        data-active="true">
        <p class="testimonial-subheading">CUSTOMER FEEDBACK</p>
        <h2 class="testimonial-heading">OUR HAPPY CLIENTS</h2>
        <div class="testimonial-content">
          <p>Share what your customers are saying about your products, customer service or shipping rates.</p>
        </div>
      </div>
    {% endfor %}
  </div>

  {% if blocks_count > 0 %}
    <div class="slider-dots" id="dots-container-{{ section.id }}">
      {% for i in (1..blocks_count) %}
        {% assign dot_index = i | minus: 1 %}
        <span
          class="dot {% if forloop.first %}active{% endif %}"
          data-index="{{ dot_index }}"
          title="Go to slide {{ i }}"></span>
      {% endfor %}
    </div>
  {% else %}
    {% comment %} Placeholder dots for the default empty state {% endcomment %}
    <div class="slider-dots" id="dots-container-{{ section.id }}">
      <span
        class="dot active"
        data-index="0"
        title="Placeholder slide 1"></span>
      <span
        class="dot"
        data-index="1"
        title="Placeholder slide 2"></span>
      <span
        class="dot"
        data-index="2"
        title="Placeholder slide 3"></span>
      <span
        class="dot"
        data-index="3"
        title="Placeholder slide 4"></span>
    </div>
  {% endif %}
</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
      const sectionId = '{{ section.id }}';
      const sliderContainer = document.getElementById(`testimonial-slider-container-${sectionId}`);
      const dotsContainer = document.getElementById(`dots-container-${sectionId}`);
      const slides = sliderContainer.querySelectorAll('.testimonial-slide');
      const dots = dotsContainer.querySelectorAll('.dot');
      const sliderElement = document.getElementById(`testimonial-slider-${sectionId}`);
      
      if (!sliderElement || slides.length === 0) return;
  
      const autoRotate = parseInt(sliderElement.dataset.autoRotate);
  
      let currentIndex = 0;
      
      // Find the initially active index
      slides.forEach((slide, index) => {
        if (slide.classList.contains('active')) {
          currentIndex = index;
        }
      });
  
      let interval;
      const FADE_DURATION = 500; 
      
      function updateSlider(newIndex) {
        if (newIndex < 0) {
          newIndex = slides.length - 1;
        } else if (newIndex >= slides.length) {
          newIndex = 0;
        }
        
        const currentSlide = slides[currentIndex];
        const nextSlide = slides[newIndex];
  
        if (currentSlide === nextSlide) return;
        
        
        currentSlide.classList.remove('active');
        
        sliderContainer.style.height = `${nextSlide.offsetHeight}px`; 
        
        // 3. Deactivate current dot
        dots[currentIndex].classList.remove('active');
  
        
        setTimeout(() => {
          // 4. Activate the new slide and dot (initiates the fade-in)
          nextSlide.classList.add('active');
          dots[newIndex].classList.add('active');
        }, FADE_DURATION - 50);
  
        currentIndex = newIndex;
      }
  
      function startAutoRotate() {
        if (autoRotate > 0) {
          clearInterval(interval);
          interval = setInterval(() => {
            updateSlider(currentIndex + 1);
          }, autoRotate * 1000); 
        }
      }
  
      function stopAutoRotate() {
        clearInterval(interval);
      }
  
      // --- Initialization ---
      
      window.addEventListener('load', () => {
        updateSlider(currentIndex); 
        startAutoRotate();
      });
      
      window.addEventListener('resize', () => {
        sliderContainer.style.height = `${slides[currentIndex].offsetHeight}px`;
      });
      
      if (slides[currentIndex]) {
        sliderContainer.style.height = `${slides[currentIndex].offsetHeight}px`;
      }
  
      // --- Event Listeners ---
      
      dots.forEach(dot => {
        dot.addEventListener('click', function() {
          stopAutoRotate();
          const index = parseInt(this.dataset.index);
          updateSlider(index);
          startAutoRotate(); 
        });
      });
      
      sliderContainer.addEventListener('mouseenter', stopAutoRotate);
      sliderContainer.addEventListener('mouseleave', startAutoRotate);
    });
</script>

{% schema %}
  {
    "name": "Quote/Testimonial Slider",
    "tag": "section",
    "class": "section-quote-slider",
    "settings": [
      {
        "type": "header",
        "content": "Slider Settings"
      }, {
        "type": "range",
        "id": "auto_rotate",
        "min": 0,
        "max": 15,
        "step": 1,
        "unit": "s",
        "label": "Auto rotate between slides",
        "info": "Set to 0 to disable auto-rotation.",
        "default": 8
      }, {
        "type": "color_scheme",
        "id": "color_scheme",
        "label": "Color scheme",
        "default": "scheme_3"
      }, {
        "type": "checkbox",
        "id": "separator",
        "label": "Separate section with border",
        "default": false
      }
    ],
    "blocks": [
      {
        "type": "testimonial",
        "name": "Testimonial/Quote",
        "settings": [
          {
            "type": "header",
            "content": "Content"
          }, {
            "type": "text",
            "id": "subheading",
            "label": "Subheading",
            "default": "Customer Feedback"
          }, {
            "type": "text",
            "id": "heading",
            "label": "Heading",
            "default": "Our Happy Clients"
          }, {
            "type": "richtext",
            "id": "content",
            "label": "Content",
            "default": "<p>Sleek and compact, this piece keeps everything organized with just the right balance of structure and softness.</p>"
          }
        ]
      }
    ],
    "presets": [
      {
        "name": "Quote/Testimonial",
        "category": "Text",
        "blocks": [
          {
            "type": "testimonial",
            "settings": {
              "subheading": "OWN DESIGN & FUNCTION",
              "heading": "Minimalist Mastery",
              "content": "<p>Minimalist design meets everyday function â€” perfect for keeping your essentials secure and stylish on the go.</p>"
            }
          }, {
            "type": "testimonial",
            "settings": {
              "subheading": "QUALITY & FEEL",
              "heading": "Premium Comfort",
              "content": "<p>Sleek and compact, this piece keeps everything organized with just the right balance of structure and softness.</p>"
            }
          }, {
            "type": "testimonial",
            "settings": {
              "subheading": "A REFINED CHOICE",
              "heading": "Standout Style",
              "content": "<p>Whether in classic black or a bold tone, it stands out for its smart compartments and refined leather finish.</p>"
            }
          }, {
            "type": "testimonial",
            "settings": {
              "subheading": "CUSTOMER SUPPORT",
              "heading": "Helpful Team",
              "content": "<p>The customer service team answered all my questions promptly and kindly. It's rare to find such dedicated support. Five stars!</p>"
            }
          }
        ]
      }
    ]
  }
{% endschema %}